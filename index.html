<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: Helvetica, Arial, sans-serif;
}
/* From the css we can manage size of the sunburst chart */
#gameboard {
  height: 900px;
  width: 900px;
}

path {
  stroke: #fff;
}

text {
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
</style>

<body>
  <!--https://bl.ocks.org/denjn5/1a3f8e44cdcb3054121dfd991f59fbc2-->
  <svg id="gameboard"></svg>
  <label><input class="mode" type="radio" name="mode" value="linear" checked> Linear</label>
  <label><input class="mode" type="radio" name="mode" value="grouped"> Grouped</label>
</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<script type="text/javascript">
    var data = [];
    fetch('https://tradingtimeline.com/get-data.php?name=Trials').then(response => response.json()).then(sheet => {
        sheet.values.forEach(function (cell) {
            // Edit the data as needed
            var link = cell[2].trim();
            var links = link.split('/');
            var nct = links[links.length - 1];
            var fdaDesignation = cell[9].trim();
            if (fdaDesignation == 'None') {
                fdaDesignation = 'None';
            }
            var platform = cell[10].trim();
            if (platform.includes('Immunocytokine')) {
                if (typeof cell[11] == 'undefined') {
                    partnerCompanies = null;
                } else {
                    partnerCompanies = cell[11].trim();
                }
                // Now push the edited data to the final output in the right order.
                data.push({
                    platform: cell[10].trim(),
                    ibrxDrug: cell[6].trim(),
                    partnerDrug: cell[7].trim(),
                    indication: cell[0].trim(),
                    phase: cell[5].trim(),
                    fdaDesignation: fdaDesignation,
                    nct: '<a href="' + link + '">' + nct + '</a>'
                });
            }
        });
        // Sort the columns so that like cell data is next to each other starting from the left. 
        data.sort(function (a, b) {
            return a.platform.localeCompare(b.platform) || a.ibrxDrug.localeCompare(b.ibrxDrug) || a.partnerDrug.localeCompare(b.partnerDrug) || a.indication.localeCompare(b.indication) || a.phase.localeCompare(b.phase) || a.link.localeCompare(b.link) || a.fdaDesignation.localeCompare(b.fdaDesignation);
        });
        var csv = [];
        data.forEach(function (item) {
            csv.push(Object.values(item).join(','));
        });
        console.log(csv); // Use the browser tools to view data in the console (click on ...)
    });
</script>


<!--
// INSTRUCTION: DO NOT modify lines 33-74 above without asking. 

// INSTRUCTION: You can convert the CSV after line 74 if you want. Who cares. . . I don't think I do. 

// INSTRUCTION: Comment every line of code you change

// INSTRUCTION: This sunburst should automatically adjust to the data it gets. You can't hard code the # of rings. For example, 
    // the current data has 7 rings. I should be able to delete items and the chart should update with less rings. So if I delete 
    // partnerDrug and phase from lines 56 and 57 above, then the sunburst should only have 5 rings. 
    // The way sunbursts work is that identical data gets merged into a node. So the default data has 19 instances of "N-803". 
    // These should be merged into a single node and there should be a number of radiating lines from that single node. 
    // For an example of combined nodes see https://observablehq.com/@d3/zoomable-sunburst. This should work exactly like that. 

// INSTRUCTION: If the data has a null entry, don't draw a node on the outer ring. Don't color a node on an inner ring. See an example
    // here: http://sushanthece.github.io/D3-Zoomable-Sun-Burst/

// INSTRUCTION: If there's a link in the data, there needs to be a link in the chart. E.g.: all "NCT" data is linked to 
     // a webpage that opens in a new window. 

// INSTRUCTION: I would like to have a label in the center that I can style with CSS. It can be a hard coded var" 
     // var centerLabel = "my string"
     // See example: https://codepen.io/thecraftycoderpdx/pen/rJYNRv

// INSTRUCTION: Data/words need to neatly inside the nodes. Last to guys had text overflowing and it was unreadable. 
     // Some of the strings are long. Make the node longer or break the string at whitespace and wrap it. Only wrap on whitespace.
     // I set the font size and style. Don't change it. 

--> 

<script>
$(function () {
    // helpful: https://bl.ocks.org/kerryrodden/477c1bfb081b783f80ad
    // For reference ONLY. It's cool, but don't need it now. https://itecnote.com/tecnote/javascript-improving-d3-sequence-sunburst-example/
    // Global Variables
    var gWidth = $('#gameboard').width(),   // Width of the svg palette
        gHeight = $('#gameboard').height(),   // Height of the svg palette
        radius = (Math.min(gWidth, gHeight) / 2) - 10,

        // INSTRUCTION: Delete this data ( the var quote), rename the variable to gsheetData, and use the var data on line 34 above.

        quote = ["Acrobat sign", "Developer Guide[node2 [node3]] God[g2316] so[g3779] loved[g25] the world[g2889], that[g5620] he gave[g1325] his[g846] only begotten[g3439] Son[g5207], that[g2443] whosoever[g3956] believeth[g4100] in[g1519] him[g846] should[g622] not[g3361] perish[g622], but[g235] have[g2192] everlasting[g166] life[g2222]. For[g1063] God[g2316] sent[g649] not[g3756] his[g846] Son[g5207] into[g1519] the world[g2889] to[g2443] condemn[g2919] the world[g2889]; but[g235] that[g2443] the world[g2889] through[g1223] him[g846] might be XXX[g4982]."],
        mode = $('.mode:checked').val(), // Linear or grouped, based on radio buttons
        svg = d3.select("svg").append("g").attr("transform", "translate(" + gWidth / 2 + "," + (gHeight / 2) + ")"),
        color_palettes = [['#4abdac', '#fc4a1a', '#f7b733']]; // D3 uses these base colors to create all the other colors

    // D3 Global Variables
    var root = textToHierarchy(quote[0], quote[1], quote[2]),
        node = root, // Save root for tweening
        x = d3.scaleLinear().range([0, 2 * Math.PI]),
        y = d3.scaleLinear().range([0, radius]),
        color = d3.scaleLinear().domain([0, 0.5, 1]).range(color_palettes[~~(Math.random() * 1)]), 
        partition = d3.partition();

    // Calculate the d path for each slice.
    var arc = d3.arc()
        .startAngle(function (d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x0))); })
        .endAngle(function (d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x1))); })
        .innerRadius(function (d) { return Math.max(0, y(d.y0)); })
        .outerRadius(function (d) { return Math.max(0, y(d.y1)); });

    // Build the sunburst.
    var first_build = true;
    function update() {
        // Determine how to size the slices.
        if (mode == "linear") {
            root.sum(function (d) { return d.size; });
        } else {
            root.sum(function (d) { return d.grpSize; });
        }

        for (let i = 0; i < partition(root).descendants().length; i++) {
            var ang = x((partition(root).descendants()[i].x0 + (x((partition(root).descendants()[i].x1) / 2) - Math.PI / 2) / Math.PI * 180));
            partition(root).descendants()[i].textAngle = (ang >= 90) ? 90 + ang : ang
        }

        if (first_build) {
            var g = svg
                .selectAll("g")
                .data(partition(root).descendants()).enter()
                .append("g");

            svg.exit().remove();
            // Add a <path d="[shape]" style="fill: [color];"><title>[popup text]</title></path>
            //   to each <g> element; add click handler; save slice widths for tweening
            var path = g.append("path")
                .style("fill", function (d) { return d.parent ? color(d.x0) : "white"; })  // Return white for root.
                .on("click", click);

            //Adding Label
            var text = g
                .append("text")
                .attr("dy", ".35em") // vertical-align
                .text(function (d) { return d.parent ? d.data.word : '' })
                .attr('id', function (d) { return 'w' + d.data.word })
                .on("click", click);

            // Outer Layer Path Cursor Pointer
            path.filter(d => d.depth == 2)
                .on("mouseover", function (d, i) {
                    d3.select(this).style("cursor", "pointer");
                })
                .on("click", click);

            // Outer Layer Text Cursor Pointer & Text Underline
            text.filter(d => d.depth == 2)
                .on("mouseover", function (d, i) {
                    d3.select(this).style("cursor", "pointer");
                    d3.select(this).style("text-decoration", "underline");
                })
                .on("mouseout", function (d, i) {
                    d3.select(this).style("text-decoration", "None");
                })
                .on("click", click);

            //Title on mouseover
            svg.selectAll("path").append("title").text(function (d) { return d.data.word; });
            svg.selectAll("text").append("title").text(function (d) { return d.data.word; });

            first_build = false;
        } 
        else {
            svg.selectAll("path").data(partition(root).descendants());
        }

        svg.selectAll("path")
            .transition('update')
            .duration(750).attrTween('d', function (d, i) {
                return arcTweenPath(d, i)
            });

        svg.selectAll("text")
            .transition('update')
            .duration(750)
            .attrTween('transform', function (d, i) { 
                return arcTweenText(d, i) 
            })
            .attr('text-anchor', function (d) {
                return d.textAngle >= 18 ? 'end' : 'start';
            })
            .attr('dx', function (d) {
                return d.textAngle >= 18 ? 27 : -27
            })
            .attr("opacity", function (e) { 
                return e.x1 - e.x0 > 0.01 ? 1 : 0; 
            });
        // svg.selectAll("path").transition().duration(1000).attrTween("d", arcTweenData);
    }

    update(); // GO!

    // Respond to radio click.
    $('.mode').on("change", function change() {
        mode = $('.mode:checked').val();
        update();
    });

    // Respond to slice click.
    // function click(d) {
    //   node = d;
    //   svg.selectAll("path").transition().duration(1000).attrTween("d", arcTweenZoom(d));
    // }
    function click(d) {
        if (d.depth == 0 || d.depth == 1) {
            node = d;
            const total = d.x1 - d.x0
            svg.selectAll('path')
                .transition('click')
                .duration(750)
                .attrTween('d', function (d, i) { return arcTweenPath(d, i) });

            svg.selectAll('text')
                .transition('click')
                .attr('opacity', 1)
                .duration(750)
                .attrTween('transform', function (d, i) {
                    return arcTweenText(d)
                })
                .attr('text-anchor', function (d) {
                    return d.textAngle >= 18 ? 'end' : 'start';
                })
                .attr('dx', function (d) {
                    // if(d.data.name.length > 3) {
                    //   return d.textAngle > 180 ? -13 : 13
                    // }
                    return d.textAngle >= 18 ? 27 : -27
                })
                .attr("opacity", function (e) {
                    if (e.x0 >= d.x0 && e.x1 <= (d.x1 + 0.0100000000000001)) {
                        return (e.x1 - e.x0 > 0.01 ? 1 : 0);
                    } else {
                        return 0;
                    }
                });

        }
        else if (d.depth == 2) { // assumed that data having maximum 2 levels Ben NOTE: this is no long true. Could be any number of levels.
            //I do not want to programmatically add links. Links should come from the Google Sheet data. However, we do want to open a new window. 
            // Perhaps target="blank" should be added to the data.
            window.open("https://en.wikipedia.org/wiki/" + d.data.name, "_blank");
        }
    }

    // When switching data: interpolate the arcs in data space.
    function arcTweenData(a, i) {
        // (a.x0s ? a.x0s : 0) -- grab the prev saved x0 or set to 0 (for 1st time through)
        // avoids the stash() and allows the sunburst to grow into being
        var oi = d3.interpolate({ x0: (a.x0s ? a.x0s : 0), x1: (a.x1s ? a.x1s : 0) }, a);
        function tween(t) {
            var b = oi(t);
            a.x0s = b.x0;
            a.x1s = b.x1;
            return arc(b);
        }
        if (i == 0) {
            // If we are on the first arc, adjust the x domain to match the root node
            // at the current zoom level. (We only need to do this once.)
            var xd = d3.interpolate(x.domain(), [node.x0, node.x1]);
            return function (t) {
                x.domain(xd(t));
                return tween(t);
            };
        } else {
            return tween;
        }
    }

    function arcTweenPath(a, i) {
        var oi = d3.interpolate({ x0: (a.x0s ? a.x0s : 0), x1: (a.x1s ? a.x1s : 0), y0: (a.y0s ? a.y0s : 0), y1: (a.y1s ? a.y1s : 0) }, a)

        function tween(t) {
            var b = oi(t);

            a.x0s = b.x0;
            a.x1s = b.x1;
            a.y0s = b.y0;
            a.y1s = b.y1;

            return arc(b);
        }

        if (i == 0 && node) {

            var xd = d3.interpolate(x.domain(), [node.x0, node.x1])
            var yd = d3.interpolate(y.domain(), [node.y0, 1])
            var yr = d3.interpolate(y.range(), [node.y0 ? 40 : 0, radius])

            return function (t) {
                x.domain(xd(t));
                y.domain(yd(t)).range(yr(t));

                return tween(t);
            };
        } else {
            // first build
            return tween;
        }
    }

    // Take text from Strong's and format as hierarchy with root.
    function textToHierarchy(rootNode, quote) {
        var vsWords = quote.replace(/[^A-Za-z0-9 /[]/g, "").replace(/[/[]/g, "|").split(" ");
        var sbWords = [{ "name": rootNode, "parent": "" }];

        for (i = 0; i < vsWords.length; i++) {
            //sbWords.filter(function (value) { return value == vsWords[i]; }).length;
            word = vsWords[i].split("|");

            if (word.length == 1) {
                sbWords.push({ "name": i, "word": word[0], "parent": rootNode, "size": 1, "grpSize": 0 });
            } else {
                // If this combo of English:Greek word exists, then add a 
                filtered = sbWords.filter(function (value) { return value.word == word[1] && value.eWord == word[0]; });

                var newGrpSize = 1;
                if (filtered.length > 0) {
                    filtered[0].grpSize += 1;
                    newGrpSize = 0;
                }

                sbWords.push({ "name": word[1], "parent": i, "word": word[1], "size": 1, "grpSize": newGrpSize, "eWord": word[0] });
                sbWords.push({ "name": i, "word": word[0], "parent": rootNode, "size": 0, "grpSize": 0 });
            }
        }

        var root = d3.stratify().id(function (d) { return d.name; })
            .parentId(function (d) { return d.parent; })(sbWords);

        return root;
    }

    // function computeTextRotation(d) {
    //   console.log(d);
    //       //return ((x(d.x0 + d.x1 / 2) - Math.PI / 2) / Math.PI) * 180;

    //       return (x(d.x0 + d.x1 / 2) - Math.PI / 2) / Math.PI * 180;
    //     }

    function arcTweenText(a, i) {
        var oi = d3.interpolate({ x0: (a.x0s ? a.x0s : 0), x1: (a.x1s ? a.x1s : 0), y0: (a.y0s ? a.y0s : 0), y1: (a.y1s ? a.y1s : 0) }, a);

        function tween(t) {
            var b = oi(t)
            var ang = ((x((b.x0 + b.x1) / 2) - Math.PI / 2) / Math.PI * 180)

            b.textAngle = (ang > 90) ? 180 + ang : ang
            a.centroid = arc.centroid(b)

            return 'translate(' + arc.centroid(b) + ')rotate(' + b.textAngle + ')'
        }
        return tween;
    }
});
</script>


